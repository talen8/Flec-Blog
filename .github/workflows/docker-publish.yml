name: Docker æž„å»ºå‘å¸ƒ

on:
  push:
    tags: ["v*"]

env:
  IMAGE_NAME: flec-web

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Node.js çŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ç”Ÿæˆæ ‡ç­¾
        id: tags
        run: |
          IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}"
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            # æ£€æŸ¥æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ (åŒ…å« alpha, beta, rc ç­‰)
            if [[ "$VERSION" =~ (alpha|beta|rc|pre) ]]; then
              echo "tags=${IMAGE}:${VERSION}" >> $GITHUB_OUTPUT
              echo "is_prerelease=true" >> $GITHUB_OUTPUT
              echo "æ£€æµ‹åˆ°é¢„å‘å¸ƒç‰ˆæœ¬: v${VERSION} (ä¸æ‰“ latest æ ‡ç­¾)"
            else
              echo "tags=${IMAGE}:${VERSION},${IMAGE}:latest" >> $GITHUB_OUTPUT
              echo "is_prerelease=false" >> $GITHUB_OUTPUT
              echo "æ­£å¼ç‰ˆæœ¬: v${VERSION} (æ‰“ latest æ ‡ç­¾)"
            fi
          else
            echo "tags=${IMAGE}:latest" >> $GITHUB_OUTPUT
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: æž„å»ºé™æ€æ–‡ä»¶
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          npm ci
          npm run build
          
          # æ‰“åŒ…æž„å»ºäº§ç‰©
          cd dist
          tar -czf ../flec-web_${VERSION}_dist.tar.gz .
          cd ..
          
          # ç”Ÿæˆæ ¡éªŒå’Œ
          sha256sum flec-web_${VERSION}_dist.tar.gz > checksums.txt

      - name: æž„å»ºå¹¶æŽ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.tags.outputs.tags }}

      - name: ç”Ÿæˆ Changelog
        id: changelog
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREV_TAG" ]; then
            COMMITS=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges -10)
          fi

          # æ£€æŸ¥æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          if [[ "$VERSION" =~ (alpha|beta|rc|pre) ]]; then
            RELEASE_TYPE="é¢„å‘å¸ƒç‰ˆæœ¬ (Pre-release)"
          else
            RELEASE_TYPE="æ­£å¼ç‰ˆæœ¬ (Stable Release)"
          fi

          # ç”Ÿæˆ changelog
          cat > release_notes.md << EOF
          ## ðŸŽ‰ ç‰ˆæœ¬ ${VERSION} å‘å¸ƒ
          
          ${RELEASE_TYPE}

          ### ðŸ“‹ æž„å»ºä¿¡æ¯
          - **ç‰ˆæœ¬**: v${VERSION}
          - **Commit**: ${GITHUB_SHA:0:7}
          - **æž„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          - **Node ç‰ˆæœ¬**: $(node --version)

          ### ðŸ“ æ›´æ–°å†…å®¹
          ${COMMITS}
          EOF

          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release_notes.md
          draft: false
          prerelease: ${{ steps.tags.outputs.is_prerelease == 'true' }}
          generate_release_notes: true
          files: |
            flec-web_*.tar.gz
            checksums.txt
