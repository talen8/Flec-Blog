name: GitHub Release å‘å¸ƒ

on:
  push:
    tags: ["v*"]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Node.js çŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: æ£€æµ‹ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          # æ£€æŸ¥æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ (åŒ…å« alpha, beta, rc ç­‰)
          if [[ "$VERSION" =~ (alpha|beta|rc|pre) ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°é¢„å‘å¸ƒç‰ˆæœ¬: v${VERSION}"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "æ­£å¼ç‰ˆæœ¬: v${VERSION}"
          fi

      - name: æž„å»ºé™æ€æ–‡ä»¶
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          npm ci
          npm run build
          
          # æ‰“åŒ…æž„å»ºäº§ç‰©
          cd dist
          tar -czf ../flec-blog_${VERSION}_dist.tar.gz .
          cd ..
          
          # ç”Ÿæˆæ ¡éªŒå’Œ
          sha256sum flec-blog_${VERSION}_dist.tar.gz > checksums.txt

      - name: ç”Ÿæˆ Changelog
        id: changelog
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREV_TAG" ]; then
            COMMITS=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges -10)
          fi

          # æ£€æŸ¥æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          if [[ "$VERSION" =~ (alpha|beta|rc|pre) ]]; then
            RELEASE_TYPE="é¢„å‘å¸ƒç‰ˆæœ¬ (Pre-release)"
          else
            RELEASE_TYPE="æ­£å¼ç‰ˆæœ¬ (Stable Release)"
          fi

          # ç”Ÿæˆ changelog
          cat > release_notes.md << EOF
          ## ðŸŽ‰ ç‰ˆæœ¬ ${VERSION} å‘å¸ƒ
          
          ${RELEASE_TYPE}

          ### ðŸ“‹ æž„å»ºä¿¡æ¯
          - **ç‰ˆæœ¬**: v${VERSION}
          - **Commit**: ${GITHUB_SHA:0:7}
          - **æž„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          - **Node ç‰ˆæœ¬**: $(node --version)

          ### ðŸ“ æ›´æ–°å†…å®¹
          ${COMMITS}
          EOF

          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release_notes.md
          draft: false
          prerelease: ${{ steps.version.outputs.is_prerelease == 'true' }}
          generate_release_notes: true
          files: |
            flec-blog_*.tar.gz
            checksums.txt
